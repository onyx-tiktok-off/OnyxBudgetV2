<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Onyx Budget V2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    html, body {
      min-height: 100vh;
      font-family: 'Inter', 'Montserrat', Arial, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a0033 100%);
      overflow-x: auto;
      font-size: 16px;
    }
    .glass {
      background: rgba(255,255,255,0.05);
      border: 1.5px solid rgba(255,255,255,0.15);
      box-shadow: 0 4px 48px 8px rgba(99,102,241,0.12), 0 2px 8px rgba(0,217,255,0.12);
      backdrop-filter: blur(24px);
      border-radius: 2rem;
    }
    select, select option, select optgroup {
      background: #18181b !important;
      color: #fff !important;
    }
    ::-webkit-scrollbar {width: 8px;background: rgba(26,0,51,0.5);}
    ::-webkit-scrollbar-thumb {background: linear-gradient(135deg, #6366f1 0, #00d9ff 100%);border-radius: 4px;}
    ::selection { background: #6366f1 !important; color: #fff !important; }
    input::selection, textarea::selection { background: #6366f1 !important; color: #fff !important; }
    .onyx-header { background: transparent !important; border: none !important; box-shadow: none !important; backdrop-filter: none !important; border-radius: 0 !important; }
    .onyx-title {
      font-family: 'Montserrat', 'Inter', Arial, sans-serif;
      font-weight: 500;
      font-size: 2.2rem;
      letter-spacing: .02em;
      background: linear-gradient(90deg,#fff 60%,#babdc4 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      line-height: 1.26;
      display: inline-block;
      padding-bottom: 2px;
      margin-top: 1px;
    }
    @media (max-width:600px) {.onyx-title { font-size: 1.3rem;}}
    @media (max-width: 680px) {html, body { font-size: 15px; }}
    .menu-categories button, .menu-categories span, .menu-categories { color: #fff !important; }
    .badge-anim-pop {
      animation: badgePop 0.72s cubic-bezier(.65,-0.3,.63,1.36);
    }
    @keyframes badgePop {
      0% { transform: scale(0.5) rotate(-20deg); opacity:0; }
      60% { transform: scale(1.15) rotate(8deg); opacity:1; }
      90% { transform: scale(1) rotate(-2deg);}
      100% { transform: scale(1) rotate(0);}
    }
    .check-anim {
      animation: checkMark 1.2s cubic-bezier(.57,2.2,.34,.97);
    }
    @keyframes checkMark {
      0%{ transform:scale(0) rotate(-40deg);}
      50%{ transform:scale(1.2) rotate(8deg);}
      75%{ transform:.92) rotate(-4deg);}
      100%{ transform:scale(1) rotate(0);}
    }
    .mic-glow {
      box-shadow: 0 0 0 2px #00d9ff, 0 0 16px 4px #00d9ffbb;
      animation: micPulse 1.4s infinite alternate;
    }
    @keyframes micPulse {
      0%{ box-shadow: 0 0 0 2px #00d9ff, 0 0 12px 2px #00d9ff55; }
      100%{ box-shadow: 0 0 0 5px #00d9ff, 0 0 22px 7px #00d9ffbb;}
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
// --- UTILITAIRES & CONST
function Lucide(props) {
  React.useEffect(()=>{if(window.lucide) window.lucide.createIcons();},[props.icon]);
  return <i data-lucide={props.icon} className={props.className} style={{display:"inline-block",verticalAlign:"middle",color:props.color||"inherit"}}></i>
}
const CATEGORIES = [
  {icon:"wallet", name:"Revenus", color:"#10b981"},
  {icon:"shopping-cart", name:"Alimentation", color:"#00d9ff"},
  {icon:"utensils", name:"Restaurants", color:"#ffb700"},
  {icon:"coffee", name:"Cafés / Bars", color:"#ff006e"},
  {icon:"home", name:"Logement", color:"#6366f1"},
  {icon:"flame", name:"Énergie / Gaz", color:"#6366f1"},
  {icon:"droplet", name:"Eau", color:"#0ea5e9"},
  {icon:"wifi", name:"Internet / Télécom", color:"#6366f1"},
  {icon:"phone", name:"Téléphone", color:"#6366f1"},
  {icon:"car", name:"Voiture", color:"#2563eb"},
  {icon:"bus", name:"Transports en commun", color:"#22d3ee"},
  {icon:"bicycle", name:"Vélo / Mobilité douce", color:"#06b6d4"},
  {icon:"gas-pump", name:"Carburant", color:"#fdba74"},
  {icon:"plane", name:"Voyages", color:"#38bdf8"},
  {icon:"train", name:"Train", color:"#3b82f6"},
  {icon:"shopping-bag", name:"Shopping", color:"#f472b6"},
  {icon:"gift", name:"Cadeaux", color:"#ef4444"},
  {icon:"banknote", name:"Impôts / Taxes", color:"#a21caf"},
  {icon:"heart-pulse", name:"Santé", color:"#ef4444"},
  {icon:"user", name:"Famille", color:"#fb7185"},
  {icon:"users", name:"Social", color:"#00d9ff"},
  {icon:"book", name:"Éducation", color:"#818cf8"},
  {icon:"briefcase", name:"Travail", color:"#6366f1"},
  {icon:"tv", name:"Abonnements", color:"#6366f1"},
  {icon:"music", name:"Divertissement / Musique", color:"#a3e635"},
  {icon:"gamepad-2", name:"Jeux", color:"#0ea5e9"},
  {icon:"star", name:"Bonus", color:"#facc15"},
  {icon:"hammer", name:"Bricolage", color:"#eab308"},
  {icon:"paw-print", name:"Animaux", color:"#10b981"},
  {icon:"palette", name:"Culture", color:"#c026d3"},
  {icon:"film", name:"Cinéma / Spectacles", color:"#f59e42"},
  {icon:"trophy", name:"Sports", color:"#f43f5e"},
  {icon:"smartphone", name:"Électronique", color:"#0ea5e9"},
  {icon:"credit-card", name:"Crédit", color:"#6366f1"},
  {icon:"umbrella", name:"Assurance", color:"#818cf8"},
  {icon:"piggy-bank", name:"Épargne", color:"#10b981"},
  {icon:"repeat", name:"Dépenses récurrentes", color:"#6366f1"},
  {icon:"building-2", name:"Charges de copropriété", color:"#f59e42"},
  {icon:"flower", name:"Jardin / Plantes", color:"#10b981"},
  {icon:"truck", name:"Livraison", color:"#fbbf24"},
  {icon:"scissors", name:"Beauté / Coiffeur", color:"#f472b6"},
  {icon:"baby", name:"Enfants", color:"#a3e635"},
  {icon:"bug", name:"Imprévus", color:"#38bdf8"},
  {icon:"smile", name:"Autre", color:"#d1d5db"}
];
const formatAmount = (n) => n.toLocaleString('fr-FR', {style: 'currency', currency: 'EUR'});
const formatDate = (d) => new Date(d).toLocaleDateString("fr-FR",{day:"2-digit",month:"short"});
const sum = (arr, fn) => arr.reduce((acc,cur)=>acc+fn(cur),0);
const randomId = () => Math.random().toString(36).slice(2,10);
function normalizeString(str) {
  return (str||"").normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
}
function sortTransactions(arr) {
  if (!Array.isArray(arr)) return [];
  const income = arr.filter(t => t.type === "income").sort((a,b)=>b.amount - a.amount);
  const expense = arr.filter(t => t.type === "expense").sort((a,b)=>b.amount - a.amount);
  return [...income, ...expense];
}

// ----------- SAISIE VOCALE --------------
function useSpeechRecognition({onResult, lang="fr-FR"}={}) {
  const [listening, setListening] = React.useState(false);
  const [error, setError] = React.useState("");
  const recognitionRef = React.useRef(null);

  function start() {
    setError("");
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      setError("Non supporté sur ce navigateur.");
      return;
    }
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!recognitionRef.current) {
      recognitionRef.current = new Recognition();
      recognitionRef.current.lang = lang;
      recognitionRef.current.interimResults = false;
      recognitionRef.current.maxAlternatives = 1;
      recognitionRef.current.onresult = (e) => {
        const res = e.results[0][0].transcript;
        setListening(false);
        onResult && onResult(res);
      };
      recognitionRef.current.onerror = (e) => {
        setListening(false);
        setError("Erreur micro.");
      };
      recognitionRef.current.onend = () => setListening(false);
    }
    setListening(true);
    recognitionRef.current.start();
  }
  function stop() {
    if (recognitionRef.current) recognitionRef.current.stop();
    setListening(false);
  }
  React.useEffect(()=>()=>stop(),[]);
  return {listening, start, stop, error};
}
// ----------- PARSING VOCALE NATURAL LANGUAGE AMÉLIORÉ ----------
function parseFrenchNumber(str) {
  const numbers = {
    "zéro": 0, "zero":0, "un":1, "une":1, "deux":2, "trois":3, "quatre":4, "cinq":5, "six":6, "sept":7, "huit":8, "neuf":9,
    "dix":10, "onze":11, "douze":12, "treize":13, "quatorze":14, "quinze":15, "seize":16, "vingt":20, "trente":30, "quarante":40, "cinquante":50,
    "soixante":60, "soixante-dix":70, "soixante dix":70, "quatre-vingt":80, "quatre vingt":80, "quatre-vingt-dix":90, "quatre vingt dix":90,
    "cent":100, "mille":1000
  };
  let tokens = str.toLowerCase().replace(/[\-]/g,' ').split(/[\s,]+/);
  let total = 0, cur = 0;
  for(let t of tokens){
    if(numbers[t] !== undefined){
      cur += numbers[t];
    } else if (t==="et") {
      continue;
    } else if (t==="cent" || t==="cents") {
      cur = (cur||1)*100;
    } else if (t==="mille") {
      cur = (cur||1)*1000;
      total += cur; cur = 0;
    }
  }
  return total+cur;
}

function extractAmountFromText(txt) {
  let match = txt.match(/(\d+[., ]?\d*)\s*(euros?|centimes?|€)?/i);
  if(match) {
    let v = match[1].replace(',','.');
    let val = parseFloat(v);
    if(match[3] && match[3].toLowerCase().startsWith("centime")){
      val = val/100;
    }
    return { amount: val, rest: txt.replace(match[0],"") };
  }
  let mont = 0;
  let euroMatch = txt.match(/([a-z\s\-]+?)\s*euros?/i);
  if(euroMatch) {
    mont += parseFrenchNumber(euroMatch[1]);
    txt = txt.replace(euroMatch[0],"");
  }
  let centMatch = txt.match(/([a-z\s\-]+?)\s*centimes?/i);
  if(centMatch) {
    mont += parseFrenchNumber(centMatch[1]) / 100;
    txt = txt.replace(centMatch[0],"");
  }
  let euroAndCent = txt.match(/([a-z\s\-]+?)\s*euros?\s*et?\s*([a-z\s\-]+)?/i);
  if(euroAndCent) {
    let euros = parseFrenchNumber(euroAndCent[1]);
    let centimes = euroAndCent[2] ? parseFrenchNumber(euroAndCent[2]) : 0;
    if(euros || centimes) mont = euros + (centimes/100);
  }
  if(mont>0) return {amount: Math.round(mont*100)/100, rest: txt.replace(/([a-z\s\-]+?)\s*euros?(\s*et\s*[a-z\s\-]+)?/i,"")};
  let onlyCentMatch = txt.match(/([a-z\s\-]+?)\s*centimes?/i);
  if(onlyCentMatch) {
    mont = parseFrenchNumber(onlyCentMatch[1]) / 100;
    if(mont>0) return {amount: Math.round(mont*100)/100, rest: txt.replace(onlyCentMatch[0],"")};
  }
  let arr = txt.split(" ");
  if(arr.length<=2 && parseFrenchNumber(txt)>0) return {amount:parseFrenchNumber(txt), rest:""};
  return {amount:null, rest:txt};
}
function parseVoiceExpense(text) {
  if (!text) return null;
  text = text.trim().toLowerCase();
  let {amount, rest} = extractAmountFromText(text);
  let titre = "";
  let categorie = null;
  titre = rest
    .replace(/payer|payé|acheté|pour|dépensé|j'ai|ai|le|du|la|des|un|une|de|ce matin|ce soir|hier|avant-hier|aujourd'hui|le|à|en|sur|dans/gi, "")
    .trim();
  const tnorm = normalizeString(titre);
  const catFound = CATEGORIES.find(cat =>
    tnorm.includes(normalizeString(cat.name))
    || normalizeString(cat.name).includes(tnorm)
    || tnorm.startsWith(normalizeString(cat.name).split(" ")[0])
  );
  if (catFound) categorie = catFound;
  if (!categorie && titre) {
    const fallback = [
      ["café","Cafés / Bars"],["loyer","Logement"],["spotify","Abonnements"],["facture","Énergie / Gaz"],["restaurant","Restaurants"],["courses","Alimentation"],["carburant","Carburant"],["cinéma","Cinéma / Spectacles"],["taxi","Transports en commun"],["impôt","Impôts / Taxes"],["prime","Bonus"],["free","Téléphone"]
    ];
    const found = fallback.find(([mot,cat])=>normalizeString(titre).includes(mot));
    if (found) categorie = CATEGORIES.find(c=>c.name===found[1]);
  }
  if (!categorie) categorie = CATEGORIES.find(c=>c.name==="Autre");
  let type = "expense";
  if (/salaire|revenu|prime|remboursement|remboursé|rembourse/i.test(text)) type = "income";
  let now = new Date();
  let date = now;
  if (/hier/i.test(text)) date = new Date(now.getTime() - 864e5);
  if (/avant-hier/i.test(text)) date = new Date(now.getTime() - 2*864e5);
  let dayMatch = text.match(/(\d{1,2})\s?(janv|févr|mars|avr|mai|juin|juil|août|sept|oct|nov|déc)/i);
  if (dayMatch) {
    let m = ["janv","févr","mars","avr","mai","juin","juil","août","sept","oct","nov","déc"];
    let d = parseInt(dayMatch[1],10), idx = m.findIndex(mois=>dayMatch[2].toLowerCase().startsWith(mois));
    if (idx>=0) {
      let dt = new Date();
      dt.setMonth(idx);
      dt.setDate(d);
      date = dt;
    }
  }
  if (/ce matin|aujourd'hui/i.test(text)) date = now;
  let tags = [];
  titre = titre.replace(/^[.,\s-]+|[.,\s-]+$/g,"");
  if (!titre) titre = categorie.name;
  if (amount === null) return null;
  return {
    id: randomId(),
    title: titre.charAt(0).toUpperCase()+titre.slice(1),
    amount: amount,
    date: date,
    category: categorie,
    type,
    tags
  }
}

    // --------------- HEADER -----------------
function Header({onAdd, onImport, onExport, showChart, toggleChart}) {
  return (
    <header className="onyx-header flex items-center justify-between px-5 pt-4 pb-1 select-none">
      <div className="flex items-center gap-4">
        <img src="https://i.ibb.co/5WMnx7y6/8ba349756916.png" alt="logo" style={{height:52, width:"auto", marginRight:10}} />
        <span className="onyx-title tracking-tight select-none" style={{fontWeight:500, fontSize:"2.2rem", fontFamily:'Montserrat,Inter,sans-serif', letterSpacing:".01em"}}>Onyx Budget V2</span>
      </div>
      <div className="flex gap-2 items-center">
        <button className="hover:scale-110 transition rounded-xl px-4 py-1 text-base font-medium glass" style={{background:"#19181d99"}} onClick={onAdd}>
          <Lucide icon="plus-circle" className="inline mr-1" /> Ajouter
        </button>
        <button className="hover:scale-110 transition rounded-xl px-4 py-1 text-base font-medium glass" style={{background:"#19181d99"}} onClick={onImport}>
          <Lucide icon="upload-cloud" className="inline mr-1" /> Import
        </button>
        <button className="hover:scale-110 transition rounded-xl px-4 py-1 text-base font-medium glass" style={{background:"#19181d99"}} onClick={onExport}>
          <Lucide icon="download-cloud" className="inline mr-1" /> Export
        </button>
        <button className={"rounded-full p-2 ml-2 "+(showChart?"bg-[#282c38]":"glass")} title={showChart?"Cacher le graphique":"Afficher le graphique"} onClick={toggleChart}>
          <Lucide icon={showChart?"eye-off":"bar-chart-3"} />
        </button>
      </div>
    </header>
  );
}

// --------------- BADGE ANIMÉ -----------------
function Badge({label, icon, color, className=""}) {
  return (
    <div className={`flex items-center px-3 py-1 rounded-xl font-medium text-sm badge-anim-pop shadow-md`} style={{background:color+"44",color}} >
      <Lucide icon={icon} className="mr-2" color={color}/>
      {label}
    </div>
  );
}

// --------------- CONFETTI / ANIM -----------------
function fireConfetti() {
  if(window.confetti){
    window.confetti({
      particleCount: 90,
      spread: 64,
      angle: 72+Math.random()*30,
      origin: { x: 0.4+0.2*Math.random(), y: 0.85 }
    });
  }
}

// --------------- DASHBOARD + GRAPHIQUE -----------------
function Dashboard({transactions, onEdit, showChart, solde, epargne}) {
  // Données pour le graphique intelligent
  const sorted = React.useMemo(()=>[...transactions].sort((a,b)=>new Date(a.date)-new Date(b.date)),[transactions]);
  const totalRevenus = sum(transactions.filter(t=>t.type==="income"), t=>t.amount);
  let points = [];
  let cumul = 0;
  let maxSolde = totalRevenus;
  sorted.forEach(t=>{
    if(t.type==="income") cumul += t.amount;
    else cumul -= t.amount;
    points.push({date: new Date(t.date), cumul: Math.round(cumul*100)/100, t});
    if(cumul>maxSolde) maxSolde = cumul;
  });
  if(!points.length && totalRevenus>0){
    points = [{date:new Date(),cumul:totalRevenus,t:{}}];
  }
  // Format pour labels : 
  const labels = points.map(pt=>formatDate(pt.date));
  const dataCumul = points.map(pt=>pt.cumul);
  const chartRef = React.useRef();

  React.useEffect(()=>{
    if(!showChart) return;
    if(!chartRef.current) return;
    let chart = chartRef.current._chart;
    if(chart) chart.destroy();
    const ctx = chartRef.current.getContext("2d");
    chartRef.current._chart = new window.Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: "Solde restant",
            data: dataCumul,
            borderColor: "#00d9ff",
            backgroundColor: "#00d9ff22",
            pointBackgroundColor: "#fff",
            pointRadius: 5,
            borderWidth: 3,
            fill: false,
            tension:.45
          }
        ]
      },
      options: {
        plugins:{
          legend: {display:false},
          tooltip: {
            callbacks: {
              label: (ctx) => `Solde : ${formatAmount(ctx.parsed.y)}`
            }
          }
        },
        scales: {
          y: {
            ticks: {color:'#fff',font:{weight:'bold'}},
            grid:{color:"#6366f155"},
            beginAtZero:true,
            min: Math.min(0, ...dataCumul)
          },
          x: {
            ticks: {color:'#fff',font:{weight:'bold'}},
            grid:{color:"#6366f122"}
          }
        }
      }
    });
  }, [showChart,transactions]);
  
  return (
    <div className="w-full px-3 pt-4 pb-1">
      <div className="flex flex-wrap gap-3 mb-4">
        <Badge label={"Solde "+formatAmount(solde)} icon="wallet" color="#10b981" />
        <Badge label={"Épargné "+formatAmount(epargne)} icon="piggy-bank" color="#10b981"/>
        <Badge label={"Revenus "+formatAmount(totalRevenus)} icon="plus-circle" color="#38bdf8"/>
        <Badge label={"Dépensé "+formatAmount(sum(transactions.filter(t=>t.type==="expense"), t=>t.amount))} icon="shopping-bag" color="#ff006e"/>
      </div>
      {showChart &&
        <div className="glass p-3 mt-1" style={{maxWidth:700, margin:'auto'}}>
          <canvas ref={chartRef} height={100}></canvas>
        </div>
      }
    </div>
  );
}

// --------------- TRANSACTION LIST ---------------
function TransactionList({transactions, onEdit, onDelete}) {
  if (!transactions.length) return (
    <div className="glass px-8 py-12 my-12 text-center text-gray-300">
      <Lucide icon="file-search" className="mx-auto mb-2" size={36}/>
      <div>Aucune dépense ou revenu pour l’instant.<br/><span className="text-gray-500">Ajoutez vos premiers mouvements !</span></div>
    </div>
  );
  return (
    <div className="w-full px-3">
      <div className="glass px-2 py-2 mb-4" style={{overflowX:'auto'}}>
        <table className="w-full min-w-[520px]">
          <thead>
            <tr className="text-left text-gray-400 font-medium">
              <th className="p-2">Catégorie</th>
              <th className="p-2">Titre</th>
              <th className="p-2">Date</th>
              <th className="p-2">Montant</th>
              <th className="p-2"></th>
            </tr>
          </thead>
          <tbody>
            {transactions.map((t,i)=>(
              <tr key={t.id} className={"hover:bg-[#ffffff09] transition "+(t.type==="income"?"text-green-400":"text-white")}>
                <td className="p-2">
                  <span className="inline-flex items-center gap-1">
                    <Lucide icon={t.category.icon} color={t.category.color} size={20}/>
                    <span style={{color:t.category.color}}>{t.category.name}</span>
                  </span>
                </td>
                <td className="p-2">{t.title}</td>
                <td className="p-2">{formatDate(t.date)}</td>
                <td className="p-2 font-semibold">{(t.type==="income"?"+":"-")+formatAmount(t.amount)}</td>
                <td className="p-2">
                  <button onClick={()=>onEdit(t)} className="text-blue-400 hover:scale-110">
                    <Lucide icon="edit" size={18}/>
                  </button>
                  <button onClick={()=>onDelete(t)} className="ml-2 text-rose-400 hover:scale-110">
                    <Lucide icon="trash" size={18}/>
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// --------------- AJOUT/EDITION MODAL ---------------
function AddEditModal({open, onClose, onSave, editTx, onVoice}) {
  const [title, setTitle] = React.useState(editTx?editTx.title:"");
  const [amount, setAmount] = React.useState(editTx?editTx.amount:"");
  const [date, setDate] = React.useState(editTx?new Date(editTx.date).toISOString().slice(0,10):new Date().toISOString().slice(0,10));
  const [category, setCategory] = React.useState(editTx?editTx.category:CATEGORIES[1]);
  const [type, setType] = React.useState(editTx?editTx.type:"expense");
  const inputRef = React.useRef();

  React.useEffect(()=>{
    if(open) {
      setTitle(editTx?editTx.title:"");
      setAmount(editTx?editTx.amount:"");
      setDate(editTx?new Date(editTx.date).toISOString().slice(0,10):new Date().toISOString().slice(0,10));
      setCategory(editTx?editTx.category:CATEGORIES[1]);
      setType(editTx?editTx.type:"expense");
      setTimeout(()=>{if(inputRef.current)inputRef.current.focus()},300);
    }
  },[open,editTx]);

  function handleSave(e) {
    e.preventDefault();
    if(!title || !amount || !category) return;
    onSave({
      id: editTx?editTx.id:randomId(),
      title,
      amount: Number(amount),
      date: new Date(date),
      category,
      type,
      tags: []
    });
  }

  function handleVoiceDictation() {
    if (onVoice) onVoice((parsed) => {
      if (parsed) {
        setTitle(parsed.title || "");
        setAmount(parsed.amount || "");
        setDate(parsed.date ? new Date(parsed.date).toISOString().slice(0,10) : date);
        setCategory(parsed.category || category);
        setType(parsed.type || "expense");
      }
    });
  }

  if(!open) return null;
  return (
    <div className="fixed inset-0 bg-[#1a0033cc] bg-opacity-80 z-30 flex items-center justify-center transition">
      <form onSubmit={handleSave} className="glass p-7 min-w-[320px] max-w-md w-full relative">
        <button type="button" onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><Lucide icon="x" size={24}/></button>
        <div className="text-2xl font-bold mb-4">{editTx?"Modifier":"Ajouter"} une transaction</div>
        <label className="block mb-2 text-sm text-white/80">Titre</label>
        <input ref={inputRef} className="w-full mb-4 px-3 py-2 rounded-lg glass text-white bg-[#19181d99] border-0 outline-none" value={title} onChange={e=>setTitle(e.target.value)}/>
        <label className="block mb-2 text-sm text-white/80">Montant</label>
        <input className="w-full mb-4 px-3 py-2 rounded-lg glass text-white bg-[#19181d99] border-0 outline-none" type="number" step="0.01" value={amount} onChange={e=>setAmount(e.target.value)}/>
        <label className="block mb-2 text-sm text-white/80">Catégorie</label>
        <select className="w-full mb-4 px-3 py-2 rounded-lg glass bg-[#19181d99] text-white" value={CATEGORIES.findIndex(c=>c.name===category.name)} onChange={e=>setCategory(CATEGORIES[e.target.value])}>
          {CATEGORIES.map((c,i)=>(
            <option key={c.name} value={i}>{c.name}</option>
          ))}
        </select>
        <label className="block mb-2 text-sm text-white/80">Date</label>
        <input className="w-full mb-4 px-3 py-2 rounded-lg glass text-white bg-[#19181d99] border-0 outline-none" type="date" value={date} onChange={e=>setDate(e.target.value)}/>
        <div className="flex gap-2 mb-5">
          <button type="button" onClick={handleVoiceDictation} className="rounded-full p-2 glass mic-glow hover:scale-110" title="Saisie vocale">
            <Lucide icon="mic" size={20}/>
          </button>
        </div>
        <button type="submit" className="w-full py-3 rounded-xl glass bg-[#10b981] hover:bg-[#00d9ff] text-white font-bold text-lg">{editTx?"Enregistrer":"Ajouter"}</button>
      </form>
    </div>
  );
}

// --------------- APP PRINCIPALE ---------------
function App() {
  const [transactions, setTransactions] = React.useState(()=> {
    try {
      return JSON.parse(localStorage.getItem("onyx-budget-v2")||"[]").map(t=>({...t,date:new Date(t.date)}));
    } catch(e){ return [] }
  });
  const [modal, setModal] = React.useState(false);
  const [editTx, setEditTx] = React.useState(null);
  const [showChart, setShowChart] = React.useState(()=>localStorage.getItem("onyx-budget-v2-showChart")!=="false");
  const [voiceError, setVoiceError] = React.useState("");
  const {listening, start:micStart, stop:micStop} = useSpeechRecognition({
    onResult: (txt) => {
      const parsed = parseVoiceExpense(txt);
      if(parsed) {
        setModal(true);
        setEditTx(null);
        setTimeout(()=>{
          setEditTx({...parsed,date:new Date(parsed.date)});
        },50);
        fireConfetti();
      } else {
        setVoiceError("Je n'ai pas compris la dépense.");
      }
    }
  });
  // Sauvegarde locale
  React.useEffect(()=>{
    localStorage.setItem("onyx-budget-v2", JSON.stringify(transactions));
  },[transactions]);
  React.useEffect(()=>{
    localStorage.setItem("onyx-budget-v2-showChart", showChart?"true":"false");
  },[showChart]);
  // Calculs
  const solde = sum(transactions.filter(t=>t.type==="income"), t=>t.amount) - sum(transactions.filter(t=>t.type==="expense"), t=>t.amount);
  const epargne = sum(transactions.filter(t=>t.category.name==="Épargne"), t=>t.amount);
  // Events
  function handleAdd() { setEditTx(null); setModal(true);}
  function handleEdit(tx) { setEditTx(tx); setModal(true);}
  function handleDelete(tx) {
    if(window.confirm("Supprimer cette transaction ?")) {
      setTransactions(transactions.filter(t=>t.id!==tx.id));
    }
  }
  function handleSave(tx) {
    setModal(false);
    setTimeout(()=>{fireConfetti();},400);
    setTransactions(tx0=>{
      let exists = tx0.findIndex(t=>t.id===tx.id);
      let arr = [...tx0];
      if(exists>=0) arr[exists]=tx;
      else arr.push(tx);
      return sortTransactions(arr);
    });
  }
  function handleImport() {
    let input = document.createElement("input");
    input.type = "file";
    input.accept = ".json,application/json";
    input.onchange = (e)=>{
      let file = e.target.files[0];
      if(!file) return;
      let reader = new FileReader();
      reader.onload = (evt)=>{
        try {
          let arr = JSON.parse(evt.target.result);
          if(Array.isArray(arr)){
            arr = arr.map(t=>({...t,date:new Date(t.date)}));
            setTransactions(sortTransactions(arr));
          }
        } catch(e){}
      };
      reader.readAsText(file);
    }
    input.click();
  }
  function handleExport() {
    let blob = new Blob([JSON.stringify(transactions,null,2)],{type:"application/json"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "onyx-budget-v2.json";
    a.click();
  }
  function handleVoice(cb) {
    setVoiceError("");
    micStart();
    setTimeout(()=>micStop(),12000); // sécurité
    // callback via useSpeechRecognition
  }
  // --- RENDER ---
  return (
    <div className="max-w-5xl mx-auto pb-16">
      <Header
        onAdd={handleAdd}
        onImport={handleImport}
        onExport={handleExport}
        showChart={showChart}
        toggleChart={()=>setShowChart(sc=>!sc)}
      />
      <Dashboard transactions={transactions} showChart={showChart} solde={solde} epargne={epargne} />
      <div className="px-4 pt-6">
        <TransactionList transactions={transactions} onEdit={handleEdit} onDelete={handleDelete}/>
      </div>
      <AddEditModal
        open={modal}
        onClose={()=>setModal(false)}
        onSave={handleSave}
        editTx={editTx}
        onVoice={handleVoice}
      />
      {listening &&
        <div className="fixed inset-0 bg-[#1a0033bb] z-50 flex flex-col items-center justify-center">
          <div className="p-8 glass text-center">
            <div className="mic-glow mb-4 inline-block rounded-full p-5"><Lucide icon="mic" size={36}/></div>
            <div className="text-xl font-semibold text-white mb-2">Parlez…</div>
            <div className="text-sm text-gray-400">Dites : “Courses 12 euros 50 centimes hier”</div>
            <button className="mt-6 px-4 py-2 rounded-xl bg-[#00d9ff] text-white font-semibold" onClick={micStop}>Arrêter</button>
          </div>
        </div>
      }
      {voiceError && <div className="fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl bg-rose-700 text-white text-lg">{voiceError}</div>}
    </div>
  );
}

// --- MOUNT REACT ---
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

  </script>
</body>
</html>
